<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard - Badminton Manager</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#fdf4ff; --card:#ffffff; --text:#1f1029; --muted:#6b5a86;
      --primary:#d946ef; --accent:#9333ea; --danger:#dc2626;
      --warn:#d97706; --line:#e5e0eb;
    }
    :root.dark{
      --bg:#0b1020; --card:#12172a; --text:#e9efff; --muted:#9fb2d9;
      --primary:#a855f7; --accent:#ec4899; --danger:#ef4444;
      --warn:#f59e0b; --line:#293250;
    }

    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

    .container{max-width:1200px;margin:0 auto;padding:20px}
    .grid{display:grid;gap:20px;grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.12)}
    h3{margin:0 0 12px}
    .kpi{font-size:1.6rem;font-weight:bold}

    .btn{border:1px solid var(--line);background:transparent;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;border-color:transparent}
    .btn:hover{opacity:.9}

    /* ===== Results Ticker ===== */
    .ticker{
      width:100%;
      background:linear-gradient(90deg,var(--primary),var(--accent));
      color:#fff;
      padding:6px 0;
      overflow:hidden;
      position:sticky;
      top:0;
      z-index:100;
    }
    .ticker-content{
      display:inline-block;
      white-space:nowrap;
      padding-left:100%;
      animation:scroll 18s linear infinite;
    }
    @keyframes scroll{
      from{transform:translateX(0);}
      to{transform:translateX(-100%);}
    }
  </style>
</head>
<body>
  <!-- Moving results ticker -->
  <div class="ticker">
    <div class="ticker-content" id="resultsTicker">
      üè∏ No results yet
    </div>
  </div>

  <div class="container">
    <h2>Dashboard</h2>

    <div class="grid">
      <div class="card">
        <h3>Total Players</h3>
        <div id="kpiPlayers" class="kpi">0</div>
      </div>
      <div class="card">
        <h3>Total Tournaments</h3>
        <div id="kpiTournaments" class="kpi">0</div>
      </div>
      <div class="card">
        <h3>Attendance Today</h3>
        <div id="kpiAttendance" class="kpi">0%</div>
      </div>
    </div>

    <div class="grid" style="margin-top:20px">
      <div class="card">
        <h3>Players by Gender</h3>
        <canvas id="chartGender" height="220"></canvas>
      </div>
      <div class="card">
        <h3>Matches Played</h3>
        <canvas id="chartMatches" height="220"></canvas>
      </div>
      <div class="card">
        <h3>Players by Age Group</h3>
        <canvas id="playersBar" height="220"></canvas>
      </div>
    </div>

    <div class="grid" style="margin-top:20px">
      <div class="card">
        <h3>Top Players</h3>
        <ul id="topPlayers"></ul>
      </div>
      <div class="card">
        <h3>Upcoming Tournaments</h3>
        <ul id="upcomingTournaments"></ul>
      </div>
      <div class="card">
        <h3>Recent Matches</h3>
        <ul id="recentMatches"></ul>
      </div>
    </div>
  </div>

  <script>
    // Dummy loaders (replace later with backend API if needed)
    function fetchPlayers(){
      return JSON.parse(localStorage.getItem('players')||'[]');
    }
    function fetchTournaments(){
      return JSON.parse(localStorage.getItem('tournaments')||'[]');
    }
    function fetchState(){
      return (JSON.parse(localStorage.getItem('state'))||{});
    }

    function render(){
      const players=fetchPlayers();
      const tournaments=fetchTournaments();

      document.getElementById('kpiPlayers').textContent=players.length;
      document.getElementById('kpiTournaments').textContent=tournaments.length;
      const present=players.filter(p=>p.present).length;
      const pct=players.length?Math.round(present/players.length*100):0;
      document.getElementById('kpiAttendance').textContent=pct+"%";

      drawGenderChart(players);
      drawMatchesChart(tournaments);
      drawPlayersChart(players);
      renderExtras(players,tournaments);
    }

    // Gender chart
    function drawGenderChart(players){
      const ctx=document.getElementById('chartGender');
      if(!ctx)return;
      const males=players.filter(p=>p.gender==='man'||p.gender==='boy').length;
      const females=players.filter(p=>p.gender==='woman'||p.gender==='girl').length;
      if(window.genderChart){window.genderChart.destroy();}
      window.genderChart=new Chart(ctx,{
        type:'doughnut',
        data:{labels:['Male','Female'],
          datasets:[{data:[males,females],backgroundColor:['#d946ef','#9333ea']}]},
        options:{plugins:{legend:{labels:{color:getCss('--muted')}}}}
      });
    }

    // Matches chart (dummy count)
    function drawMatchesChart(tournaments){
      const ctx=document.getElementById('chartMatches');
      if(!ctx)return;
      const total=tournaments.length*10;
      const played=Math.round(total*0.6);
      if(window.matchChart){window.matchChart.destroy();}
      window.matchChart=new Chart(ctx,{
        type:'bar',
        data:{labels:['Played','Scheduled'],
          datasets:[{data:[played,total-played],backgroundColor:['#9333ea','#d946ef'],borderRadius:6}]},
        options:{plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:getCss('--muted')}},y:{ticks:{color:getCss('--muted')},beginAtZero:true}}}
      });
    }

    // Players by Age Group chart
    function drawPlayersChart(players){
      const ctx=document.getElementById('playersBar');
      if(!ctx)return;
      const groups=["U9","U11","U13","U15","U17","U19","Men","Women","30+","35+","40+","45+"];
      const counts=groups.map(g=>players.filter(p=>p.age===g).length);
      if(window.playersChart){window.playersChart.destroy();}
      window.playersChart=new Chart(ctx,{
        type:'bar',
        data:{
          labels:groups,
          datasets:[{
            label:'Players',
            data:counts,
            backgroundColor:'rgba(217,70,239,0.7)',
            borderRadius:6
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{color:getCss('--muted')}},
            y:{ticks:{color:getCss('--muted')},beginAtZero:true}
          }
        }
      });
    }

    // Collect recent matches from state (Round Robin + KO)
    function getRecentMatches(){
      const state = fetchState();
      const rec = [];

      // Round Robin
      if(state.rr){
        Object.values(state.rr).forEach(rr=>{
          rr.groups?.forEach(g=>{
            g.matches?.forEach(m=>{
              if(m.done){
                rec.push({
                  a: m.a.name,
                  b: m.b.name,
                  score: `${m.scoreA}‚Äì${m.scoreB}`
                });
              }
            });
          });
        });
      }

      // Knockout
      if(state.ko){
        Object.values(state.ko).forEach(ko=>{
          ko.rounds?.forEach(r=>{
            r.forEach(m=>{
              if(m.done){
                rec.push({
                  a: m.a?.name||'TBD',
                  b: m.b?.name||'TBD',
                  score: `${m.scoreA}‚Äì${m.scoreB}`
                });
              }
            });
          });
        });
      }

      return rec.slice(-5).reverse(); // last 5
    }

    // Extra dashboard cards
    function renderExtras(players,tournaments){
      // Top players by wins
      const top=players.slice().sort((a,b)=>(b.stats?.W||0)-(a.stats?.W||0)).slice(0,5);
      document.getElementById('topPlayers').innerHTML=top.map(p=>`<li>${p.name} ‚Äî ${p.stats?.W||0} wins</li>`).join('')||'<li>No data</li>';

      // Upcoming tournaments
      const upcoming=tournaments.slice().sort((a,b)=>new Date(a.date)-new Date(b.date)).slice(0,5);
      document.getElementById('upcomingTournaments').innerHTML=upcoming.map(t=>`<li>${t.name} (${t.date})</li>`).join('')||'<li>No tournaments</li>';

      // Recent matches from state
      const rec = getRecentMatches();
      document.getElementById('recentMatches').innerHTML = rec.map(m=>`<li>${m.a} vs ${m.b} ‚Äî ${m.score}</li>`).join('') || '<li>No completed matches</li>';

      // Update ticker with same matches
      const ticker = document.getElementById('resultsTicker');
      ticker.textContent = rec.length ? "üè∏ Latest Results: " + rec.map(m=>`${m.a} beat ${m.b} ${m.score}`).join(" | ") : "No results yet";
    }

    function getCss(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name);
    }

    render();
  </script>
</body>
</html>
