<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üè∏ Unified Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0c0f13;
    --card:#131826;
    --muted:#9aa4b2;
    --text:#f2f5f9;
    --accent:#2a82ff;
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
    --line:#1f2738;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text);}
  header{position:sticky; top:0; z-index:5; background:#0d1220; border-bottom:1px solid var(--line);}
  .wrap{max-width:1100px; margin:0 auto; padding:16px;}
  h1{margin:0; font-size:22px;}
  .sub{color:var(--muted); font-size:13px; margin-top:4px}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); margin-top:14px;}
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(0,0,0,.25);}
  .card h3{margin:0 0 8px; font-size:16px}
  .btn{padding:6px 10px; border:1px solid var(--line); border-radius:8px; background:#0f1628; color:var(--text); cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:6px; border-bottom:1px solid var(--line); text-align:left}
  .player-row{cursor:pointer;}
  .player-row:hover{background:#1f2738;}
  /* Modal */
  .modal{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:999;}
  .modal-content{background:var(--card); border-radius:16px; padding:20px; width:90%; max-width:600px; max-height:90%; overflow:auto; position:relative;}
  .close{position:absolute; top:10px; right:14px; cursor:pointer; font-size:20px; color:var(--muted);}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üè∏ Unified Dashboard</h1>
    <div class="sub">Players, Round Robin, Bracket, and Attendance overview</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="card">
      <h3>Players</h3>
      <div id="playerCount">‚Äî</div>
      <button class="btn" onclick="goto('PlayerPage.html')">Manage</button>
    </div>
    <div class="card">
      <h3>Round Robin</h3>
      <div id="rrInfo">Loading‚Ä¶</div>
      <button class="btn" onclick="goto('TournamentPage.html')">Open</button>
    </div>
    <div class="card">
      <h3>Bracket (KO)</h3>
      <div id="koInfo">Loading‚Ä¶</div>
      <button class="btn" onclick="goto('Bracket_tournament.html')">Open</button>
    </div>
    <div class="card">
      <h3>Attendance</h3>
      <div id="attInfo">Loading‚Ä¶</div>
      <button class="btn" onclick="goto('Attendance_book.html')">Open</button>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h3>Players List</h3>
    <table>
      <thead><tr><th>Name</th><th>Category</th></tr></thead>
      <tbody id="playerTable"><tr><td colspan="2">No players yet</td></tr></tbody>
    </table>
  </div>
</main>

<!-- Modal -->
<div class="modal" id="playerModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">Player Stats</h2>
    <canvas id="pieChart" height="150"></canvas>
    <canvas id="barChart" height="150" style="margin-top:20px"></canvas>
  </div>
</div>

<script>
function goto(file){
  window.location.href = file;
}

// -------- Player Sync --------
function propagatePlayer(player){
  // Round Robin
  const req = indexedDB.open("TournamentDB",1);
  req.onsuccess = ()=>{
    const db = req.result;
    if (!db.objectStoreNames.contains("tournaments")) return;
    const tx = db.transaction("tournaments","readwrite");
    const store = tx.objectStore("tournaments");
    const g = store.get("data");
    g.onsuccess = ()=>{
      let all = {};
      try{ all = JSON.parse(g.result || "{}"); }catch{}
      Object.keys(all).forEach(cat=>{
        if (!all[cat].players.find(p=>p.name===player.name)){
          all[cat].players.push(player);
        }
      });
      store.put(JSON.stringify(all),"data");
    };
  };
  // Bracket
  const br = indexedDB.open("bracketDB",1);
  br.onsuccess = ()=>{
    const db = br.result;
    if (!db.objectStoreNames.contains("players")) return;
    const tx = db.transaction("players","readwrite");
    tx.objectStore("players").put({ category:"all", ...player });
  };
}

// -------- Load Players --------
async function loadPlayers(){
  const players = await readAllFromIDB("playerDB","players");
  document.getElementById("playerCount").textContent = players.length;
  const tbody = document.getElementById("playerTable");
  tbody.innerHTML = "";
  if (!players.length){ tbody.innerHTML="<tr><td colspan=2>No players</td></tr>"; return; }
  players.forEach(p=>{
    const tr = document.createElement("tr");
    tr.className="player-row";
    tr.innerHTML = `<td>${p.name}</td><td>${p.category||"-"}</td>`;
    tr.onclick=()=>openModal(p.name);
    tbody.appendChild(tr);
  });
}

// ---- IndexedDB Reader ----
function readAllFromIDB(dbName, storeName){
  return new Promise((resolve)=>{
    const req = indexedDB.open(dbName);
    req.onsuccess=()=>{
      const db = req.result;
      if (!db.objectStoreNames.contains(storeName)){resolve([]);return;}
      const tx=db.transaction(storeName,"readonly");
      const store=tx.objectStore(storeName);
      const getAll=store.getAll();
      getAll.onsuccess=()=>resolve(getAll.result||[]);
      getAll.onerror=()=>resolve([]);
    };
    req.onerror=()=>resolve([]);
  });
}

// -------- Player Modal --------
let pieChart, barChart;
async function openModal(playerName){
  document.getElementById("modalTitle").textContent = "Stats: "+playerName;
  const stats = await gatherStats(playerName);
  const modal=document.getElementById("playerModal");
  modal.style.display="flex";

  // Pie Chart (Wins vs Losses)
  const pieCtx=document.getElementById("pieChart").getContext("2d");
  if (pieChart) pieChart.destroy();
  pieChart=new Chart(pieCtx,{
    type:"pie",
    data:{
      labels:["Wins","Losses"],
      datasets:[{data:[stats.wins,stats.losses],backgroundColor:["#22c55e","#ef4444"]}]
    }
  });

  // Bar Chart (Points)
  const barCtx=document.getElementById("barChart").getContext("2d");
  if (barChart) barChart.destroy();
  barChart=new Chart(barCtx,{
    type:"bar",
    data:{
      labels:["Points For","Points Against"],
      datasets:[{label:"Points",data:[stats.pointsFor,stats.pointsAgainst],backgroundColor:["#2a82ff","#f59e0b"]}]
    },
    options:{scales:{y:{beginAtZero:true}}}
  });
}

function closeModal(){document.getElementById("playerModal").style.display="none";}

// ---- Gather Stats from DBs ----
async function gatherStats(name){
  let wins=0,losses=0,pointsFor=0,pointsAgainst=0;

  // Round Robin
  const rrReq=indexedDB.open("TournamentDB",1);
  await new Promise(res=>{
    rrReq.onsuccess=()=>{
      const db=rrReq.result;
      if (!db.objectStoreNames.contains("tournaments")){res();return;}
      const tx=db.transaction("tournaments","readonly");
      const store=tx.objectStore("tournaments");
      const g=store.get("data");
      g.onsuccess=()=>{
        try{
          const all=JSON.parse(g.result||"{}");
          Object.values(all).forEach(cat=>{
            (cat.matches||[]).forEach(m=>{
              if (!m.saved) return;
              if (m.a===name||m.b===name){
                const myScore=(m.a===name)?m.sa:m.sb;
                const oppScore=(m.a===name)?m.sb:m.sa;
                pointsFor+=myScore;
                pointsAgainst+=oppScore;
                if (myScore>oppScore) wins++; else losses++;
              }
            });
          });
        }catch{}
        res();
      };
    }; rrReq.onerror=()=>res();
  });

  // Bracket
  const brReq=indexedDB.open("bracketDB",1);
  await new Promise(res=>{
    brReq.onsuccess=()=>{
      const db=brReq.result;
      if (!db.objectStoreNames.contains("tournaments")){res();return;}
      const tx=db.transaction("tournaments","readonly");
      const store=tx.objectStore("tournaments");
      const c=store.openCursor();
      c.onsuccess=e=>{
        const cur=e.target.result;
        if (cur){
          const data=cur.value.data||cur.value;
          (data.rounds||[]).flat().forEach(m=>{
            if (m.a===name||m.b===name){
              const myScore=(m.a===name)?m.sa:m.sb;
              const oppScore=(m.a===name)?m.sb:m.sa;
              pointsFor+=myScore||0;
              pointsAgainst+=oppScore||0;
              if (m.winner===name) wins++; else if (m.winner && m.winner!=="BYE") losses++;
            }
          });
          cur.continue();
        } else res();
      };
    }; brReq.onerror=()=>res();
  });

  return {wins,losses,pointsFor,pointsAgainst};
}

// ---- Init ----
loadPlayers();
</script>
</body>
</html>
