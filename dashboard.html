<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üè∏ Tournament Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="db.js"></script>

<style>
:root {
  --bg:#fdf4ff; 
  --panel:#ffffff; 
  --panel-2:#f9f5ff;
  --muted:#6b5a86; 
  --text:#2d103f;
  --accent:#d946ef; 
  --win:#22c55e;    
  --loss:#ef4444;
  --neutral:#7b88a8; 
}
body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Arial; }
header {
  position:sticky; top:0; z-index:5; padding:12px 14px;
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
  background:linear-gradient(90deg,#fdf4ff,#f9f5ff);
  border-bottom:1px solid #e5e0eb;
}
h1{margin:0; font-size:18px;}
.controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

.dashboard { display:grid; grid-template-columns: repeat(12,1fr); gap:16px; padding:16px; }
.card { background:var(--panel); border:1px solid #e5e0eb; border-radius:14px; padding:16px; }
.card-header { display:flex; justify-content:space-between; margin-bottom:12px; }
.card-title { margin:0; font-size:16px; }

.card-full { grid-column: span 12; }
.card-wide { grid-column: span 8; }
.card-medium { grid-column: span 6; }
.card-narrow { grid-column: span 4; }

.ticker-container { overflow:hidden; height:40px; background:var(--panel-2); border-radius:10px; position:relative; }
.ticker { display:flex; position:absolute; white-space:nowrap; animation:ticker-scroll 30s linear infinite; }
.ticker-item { padding:0 20px; display:inline-flex; align-items:center; }
.ticker-score { font-weight:bold; margin:0 8px; color:var(--accent); }
@keyframes ticker-scroll { 0%{transform:translateX(100%);} 100%{transform:translateX(-100%);} }

.chart-container { height:300px; position:relative; }

.kpi-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
.kpi-card { background:var(--panel-2); border-radius:10px; padding:12px; text-align:center; }
.kpi-value { font-size:24px; font-weight:bold; margin:8px 0; color:var(--accent); }
.kpi-label { font-size:12px; color:var(--muted); }

.activity-feed { max-height:300px; overflow-y:auto; }
.activity-item { padding:8px 0; border-bottom:1px solid #e5e0eb; font-size:14px; }
.activity-time { font-size:12px; color:var(--muted); }

@media(max-width:768px){ .dashboard{grid-template-columns:1fr;} .card-wide,.card-medium,.card-narrow{grid-column:span 1;} }
</style>
</head>
<body>

<header>
  <h1>üè∏ Tournament Dashboard</h1>
  <div class="controls">
    <input type="date" id="dashboardDate">
    <select id="categoryFilter">
      <option value="all">All Categories</option>
      <option>U11-Boys</option><option>U11-Girls</option>
      <option>U13-Boys</option><option>U13-Girls</option>
      <option>U15-Boys</option><option>U15-Girls</option>
      <option>U17-Boys</option><option>U17-Girls</option>
      <option>U19-Boys</option><option>U19-Girls</option>
      <option>Men</option><option>Women</option>
    </select>
    <button class="btn" id="refreshBtn">üîÑ Refresh</button>
  </div>
</header>

<div class="dashboard">
  <!-- Live Ticker -->
  <div class="card card-full">
    <div class="card-header"><h2 class="card-title">Live Results</h2></div>
    <div class="ticker-container"><div class="ticker" id="liveTicker"></div></div>
  </div>

  <!-- KPIs -->
  <div class="card card-wide">
    <div class="card-header"><h2 class="card-title">Tournament Overview</h2></div>
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">Total Players</div><div class="kpi-value" id="totalPlayers">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Matches Played</div><div class="kpi-value" id="matchesPlayed">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Matches Remaining</div><div class="kpi-value" id="matchesRemaining">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Attendance Today</div><div class="kpi-value" id="attendanceToday">0%</div></div>
    </div>
  </div>

  <!-- Performance Chart -->
  <div class="card card-medium">
    <div class="card-header"><h2 class="card-title">Player Performance</h2></div>
    <div class="chart-container"><canvas id="performanceChart"></canvas></div>
  </div>

  <!-- Category Chart -->
  <div class="card card-medium">
    <div class="card-header"><h2 class="card-title">Category Distribution</h2></div>
    <div class="chart-container"><canvas id="categoryChart"></canvas></div>
  </div>

  <!-- Recent Activity -->
  <div class="card card-wide">
    <div class="card-header"><h2 class="card-title">Recent Activity</h2></div>
    <div class="activity-feed" id="activityFeed"></div>
  </div>

  <!-- Upcoming Matches -->
  <div class="card card-wide">
    <div class="card-header"><h2 class="card-title">Upcoming Matches</h2></div>
    <div id="upcomingMatches"></div>
  </div>
</div>

<script>
// ---------- Charts ----------
function initCharts(){
  const perfCtx=document.getElementById("performanceChart").getContext("2d");
  window.performanceChart=new Chart(perfCtx,{type:"bar",data:{labels:[],datasets:[
    {label:"Wins",data:[],backgroundColor:"#22c55e"},
    {label:"Losses",data:[],backgroundColor:"#ef4444"}]},options:{responsive:true,maintainAspectRatio:false}});
  const catCtx=document.getElementById("categoryChart").getContext("2d");
  window.categoryChart=new Chart(catCtx,{type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:["#d946ef","#a855f7","#3b82f6"]}]},options:{responsive:true}});
}

// ---------- Refresh ----------
async function refreshDashboard(){
  await openDB();
  const players=await getAll("players");
  const matches=await getAll("matches");

  // KPIs
  document.getElementById("totalPlayers").textContent=players.length;
  const played=matches.filter(m=>m.status==="completed").length;
  document.getElementById("matchesPlayed").textContent=played;
  document.getElementById("matchesRemaining").textContent=matches.length-played;

  // Attendance (today)
  const today=new Date().toISOString().slice(0,10);
  let attended=0;
  players.forEach(p=>{
    if(p.attendance?.some(a=>a.date===today && a.status==="Present")) attended++;
  });
  document.getElementById("attendanceToday").textContent=players.length?Math.round((attended/players.length)*100)+"%":"0%";

  // Charts
  window.performanceChart.data.labels=players.map(p=>p.name);
  window.performanceChart.data.datasets[0].data=players.map(p=>p.stats?.wins||0);
  window.performanceChart.data.datasets[1].data=players.map(p=>p.stats?.losses||0);
  window.performanceChart.update();

  const counts={};
  players.forEach(p=>{ const cat=p.category||"Uncategorized"; counts[cat]=(counts[cat]||0)+1; });
  window.categoryChart.data.labels=Object.keys(counts);
  window.categoryChart.data.datasets[0].data=Object.values(counts);
  window.categoryChart.update();

  // Live ticker
  const ticker=document.getElementById("liveTicker");
  ticker.innerHTML="";
  matches.slice(-5).forEach(m=>{
    const div=document.createElement("div");
    div.className="ticker-item";
    div.innerHTML=`${m.p1} <span class="ticker-score">${m.s1}-${m.s2}</span> ${m.p2}`;
    ticker.appendChild(div);
  });
  if(matches.length===0) ticker.innerHTML="<div class='ticker-item'>No matches</div>";

  // Recent activity
  const feed=document.getElementById("activityFeed"); feed.innerHTML="";
  players.slice(-5).reverse().forEach(p=>{
    const item=document.createElement("div");
    item.className="activity-item";
    item.innerHTML=`üë§ <strong>${p.name}</strong> (${p.country||"?"}) added/updated`;
    feed.appendChild(item);
  });

  // Upcoming matches
  const up=document.getElementById("upcomingMatches"); up.innerHTML="";
  matches.filter(m=>m.status!=="completed").slice(0,5).forEach(m=>{
    const d=document.createElement("div");
    d.className="activity-item";
    d.textContent=`${m.p1} vs ${m.p2} on ${m.date||"TBD"}`;
    up.appendChild(d);
  });
  if(up.innerHTML==="") up.innerHTML="<div class='activity-item'>No upcoming matches</div>";
}

// ---------- Sync ----------
channel.onmessage=e=>{
  if(["playerAdded","playerUpdated","matchAdded","matchUpdated"].includes(e.data.type)){
    refreshDashboard();
  }
};

// ---------- Init ----------
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("dashboardDate").valueAsDate=new Date();
  initCharts();
  refreshDashboard();
  document.getElementById("refreshBtn").onclick=refreshDashboard;
});
</script>
</body>
</html>
