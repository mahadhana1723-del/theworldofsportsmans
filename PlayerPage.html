<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üè∏ Player Manager</title>

<link rel="stylesheet" href="theme.css">
<script src="db.js"></script>
</head>
<body>

<header>
  <h1>üè∏ Player Manager</h1>
  <div class="controls">
    <input id="pId" placeholder="Player ID">
    <input id="pAadhar" placeholder="Aadhaar No.">
    <input id="pName" placeholder="Name">
    <input id="pAge" placeholder="Age" type="number">
    <input id="pCountry" placeholder="Country">
    <input id="pPhoto" type="file" accept="image/*">
    <textarea id="pBio" placeholder="Short Bio"></textarea>
    <input id="pVideo" placeholder="Video URL">
    <button class="btn primary" id="addBtn">Ôºã Add Player</button>
    <button class="btn primary" id="saveEditBtn" style="display:none">üíæ Save Edit</button>
    <input id="fileName" placeholder="File name (without .json)">
    <button class="btn" id="exportBtn">Export Players</button>
    <input id="importFile" type="file" accept="application/json" style="display:none">
    <button class="btn" id="importBtn">Import</button>
    <button class="btn" id="exportAttendanceBtn">Export Attendance</button>
  </div>
  <input id="searchBar" placeholder="üîç Search players..." style="margin-top:10px; width:100%;">
</header>

<main class="card">
  <div class="card-header"><h2 class="card-title">Players</h2></div>
  <table id="playerTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Country</th><th>Age</th><th>P</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>Edit</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<!-- Profile Popup -->
<div id="profilePopup" class="modal">
  <div class="profile-card modal-content">
    <img id="profilePhoto" src="" style="width:140px; height:140px; border-radius:50%; object-fit:cover; margin-bottom:10px;">
    <h2 id="profileName"></h2>
    <small id="profileMeta"></small>
    <p id="profileBio"></p>
    <div class="stats">
      <h3>Stats</h3>
      <table>
        <tr><th>Matches</th><td id="profileMatches"></td></tr>
        <tr><th>Wins</th><td id="profileWins"></td></tr>
        <tr><th>Losses</th><td id="profileLosses"></td></tr>
        <tr><th>Points For</th><td id="profilePF"></td></tr>
        <tr><th>Points Against</th><td id="profilePA"></td></tr>
      </table>
    </div>
    <div id="profileVideo"></div>
    <button class="btn" id="markPresent">‚úî Mark Present</button>
    <button class="btn" id="markAbsent">‚úñ Mark Absent</button>
    <button class="btn" id="closePopup" style="background:var(--loss);color:#fff">Close</button>
  </div>
</div>

<script>
const S={players:[]};
let editIndex=null;
const tableBody=document.querySelector("#playerTable tbody");
const popup=document.getElementById("profilePopup");

// -------- Init ----------
(async()=>{
  await openDB();
  S.players = await getAll("players");
  renderPlayers();
})();

// -------- Render ----------
function renderPlayers(filter=""){
  tableBody.innerHTML="";
  S.players
    .filter(p => p && p.name && p.name.toLowerCase().includes(filter.toLowerCase()))
    .forEach((p,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${p.id||"-"}</td>
        <td style="color:var(--accent); cursor:pointer;">${p.name}</td>
        <td>${p.country||""}</td>
        <td>${p.age||""}</td>
        <td>${p.stats?.matchesPlayed||0}</td>
        <td>${p.stats?.wins||0}</td>
        <td>${p.stats?.losses||0}</td>
        <td>${p.stats?.pointsFor||0}</td>
        <td>${p.stats?.pointsAgainst||0}</td>
        <td><button class="btn">‚úèÔ∏è</button></td>
      `;
      tr.querySelector("td:nth-child(2)").onclick=()=>showProfile(p,idx);
      tr.querySelector("button").onclick=(e)=>{ e.stopPropagation(); loadEdit(idx); };
      tableBody.appendChild(tr);
    });
}

// -------- Add Player ----------
document.getElementById("addBtn").onclick=async()=>{
  const p=getFormValues();
  if(!p.name) return;
  if(!p.id) p.id=crypto.randomUUID();
  await put("players",p);
  S.players.push(p);
  renderPlayers();
  clearForm();
  broadcast("playerAdded",p);
};

// -------- Save Edit ----------
document.getElementById("saveEditBtn").onclick=async()=>{
  if(editIndex===null) return;
  const updated=getFormValues(S.players[editIndex].photo);
  updated.id=S.players[editIndex].id;
  S.players[editIndex]=updated;
  await put("players",updated);
  renderPlayers();
  clearForm();
  editIndex=null;
  document.getElementById("addBtn").style.display="inline-block";
  document.getElementById("saveEditBtn").style.display="none";
  broadcast("playerUpdated",updated);
};

// -------- Helpers ----------
function getFormValues(oldPhoto=""){
  return {
    id: document.getElementById("pId").value.trim(),
    aadhar: document.getElementById("pAadhar").value.trim(),
    name: document.getElementById("pName").value.trim(),
    age: parseInt(document.getElementById("pAge").value)||"",
    country: document.getElementById("pCountry").value.trim(),
    bio: document.getElementById("pBio").value.trim(),
    photo: oldPhoto,
    videos: document.getElementById("pVideo").value ? [document.getElementById("pVideo").value] : [],
    stats:{matchesPlayed:0,wins:0,losses:0,pointsFor:0,pointsAgainst:0},
    attendance:[]
  };
}
function clearForm(){ ["pId","pAadhar","pName","pAge","pCountry","pBio","pVideo"].forEach(id=>document.getElementById(id).value=""); document.getElementById("pPhoto").value=""; }
function loadEdit(idx){
  editIndex=idx;
  const p=S.players[idx];
  document.getElementById("pId").value=p.id||"";
  document.getElementById("pAadhar").value=p.aadhar||"";
  document.getElementById("pName").value=p.name||"";
  document.getElementById("pAge").value=p.age||"";
  document.getElementById("pCountry").value=p.country||"";
  document.getElementById("pBio").value=p.bio||"";
  document.getElementById("pVideo").value=p.videos?.[0]||"";
  document.getElementById("addBtn").style.display="none";
  document.getElementById("saveEditBtn").style.display="inline-block";
}

// -------- Profile Popup ----------
function showProfile(p,index){
  document.getElementById("profilePhoto").src=p.photo||"";
  document.getElementById("profileName").textContent=p.name;
  document.getElementById("profileMeta").textContent=`ID: ${p.id||"-"} | Aadhaar: ${p.aadhar||"-"} | Age: ${p.age||"-"} | ${p.country||"-"}`;
  document.getElementById("profileBio").textContent=p.bio||"";
  document.getElementById("profileMatches").textContent=p.stats?.matchesPlayed||0;
  document.getElementById("profileWins").textContent=p.stats?.wins||0;
  document.getElementById("profileLosses").textContent=p.stats?.losses||0;
  document.getElementById("profilePF").textContent=p.stats?.pointsFor||0;
  document.getElementById("profilePA").textContent=p.stats?.pointsAgainst||0;
  document.getElementById("profileVideo").innerHTML=p.videos?.length?`<p><a href="${p.videos[0]}" target="_blank">üé• Watch Video</a></p>`:"";
  popup.style.display="flex";
  document.getElementById("markPresent").onclick=()=>markAttendance(index,"Present");
  document.getElementById("markAbsent").onclick=()=>markAttendance(index,"Absent");
}
document.getElementById("closePopup").onclick=()=>popup.style.display="none";

async function markAttendance(index,status){
  const today=new Date().toISOString().slice(0,10);
  if(!S.players[index].attendance) S.players[index].attendance=[];
  S.players[index].attendance.push({date:today,status});
  await put("players",S.players[index]);
  alert(`${S.players[index].name} marked ${status} (${today})`);
  broadcast("playerUpdated",S.players[index]);
}

// -------- Export / Import ----------
document.getElementById("exportBtn").onclick=()=>{
  const fname=document.getElementById("fileName").value.trim() || "players";
  const data=JSON.stringify({players:S.players},null,2);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
  a.download=`${fname}.json`; a.click();
};
document.getElementById("exportAttendanceBtn").onclick=()=>{
  const data=JSON.stringify({attendance:S.players.map(p=>({name:p.name,attendance:p.attendance||[]}))},null,2);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([data],{type:"application/json"}));
  a.download="attendance.json"; a.click();
};
document.getElementById("importBtn").onclick=()=>document.getElementById("importFile").click();
document.getElementById("importFile").onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ev=>{
    try{
      const o=JSON.parse(ev.target.result);
      if(o.players){ for(const p of o.players) await put("players",p); }
      if(o.attendance){ o.attendance.forEach(att=>{ const pl=S.players.find(x=>x.name===att.name); if(pl) pl.attendance=att.attendance; }); }
      S.players=await getAll("players"); renderPlayers();
    }catch(err){ alert("Bad file: "+err.message); }
  };
  r.readAsText(f);
};

// -------- Search ----------
document.getElementById("searchBar").oninput=(e)=>{ renderPlayers(e.target.value); };

// -------- Sync ----------
channel.onmessage = e=>{
  if(["playerAdded","playerUpdated"].includes(e.data.type)){
    openDB().then(()=>getAll("players")).then(players=>{ S.players=players; renderPlayers(); });
  }
};
</script>
</body>
</html>
